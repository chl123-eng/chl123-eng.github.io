{"title":"Vue3自定义图片懒加载指令","uid":"e9f45a92e7df43e08b58c2d1279189cb","slug":"Vue3自定义图片懒加载指令","date":"2023-02-24T16:00:00.000Z","updated":"2024-06-07T03:20:18.000Z","comments":true,"path":"api/articles/Vue3自定义图片懒加载指令.json","keywords":"蔡惠霖的博客，前端开发，Vue，Node.js","cover":"https://blog-1300014307.cos.ap-guangzhou.myqcloud.com/load.jpeg","content":"<p>之前用习惯了别人的图片懒加载指令，现在自己也试着写了一个，在这里记录下自己过程中的心得体会，当前指令逻辑使用于 vue2 和 vue3</p>\n<h2 id=\"图片懒加载原理\"><a href=\"#图片懒加载原理\" class=\"headerlink\" title=\"图片懒加载原理\"></a>图片懒加载原理</h2><p>使用 html 自定义数据先覆盖图片或者背景图的默认地址，从少图片资源加载，当滚动条拉动到可视区的时候才逐渐加载图片，从而提高网站性能 ## 目标 实现图片懒加载和背景图片的懒加载，并且支持自定义默认图片</p>\n<h2 id=\"开始-需要明白的两点\"><a href=\"#开始-需要明白的两点\" class=\"headerlink\" title=\"开始 需要明白的两点\"></a>开始 需要明白的两点</h2><ol>\n<li>需要设置一个自定义默认图片的自定义属性</li>\n<li>需要传入一个值设置当前是图片的懒加载还是背景图片的懒加载，背景图片需要从一开始就设定好宽度，才能计算 下面开始代码</li>\n</ol>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> &#123; <span class=\"title class_\">App</span>, <span class=\"title class_\">DirectiveBinding</span> &#125; <span class=\"keyword\">from</span> <span class=\"string\">&quot;vue&quot;</span>;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> ** <span class=\"doctag\">@Description</span>: 设置样式</span></span><br><span class=\"line\"><span class=\"comment\"> ** <span class=\"doctag\">@Author</span>: shuhongxie</span></span><br><span class=\"line\"><span class=\"comment\"> ** <span class=\"doctag\">@param</span> &#123;<span class=\"type\">any</span>&#125; arg 传入的类型</span></span><br><span class=\"line\"><span class=\"comment\"> ** <span class=\"doctag\">@param</span> &#123;<span class=\"type\">HTMLElement</span>&#125; el DOM元素</span></span><br><span class=\"line\"><span class=\"comment\"> ** <span class=\"doctag\">@param</span> &#123;<span class=\"type\">string</span>&#125; value 图片url值</span></span><br><span class=\"line\"><span class=\"comment\"> **/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">setStyle</span>(<span class=\"params\">arg: any, el: HTMLElement, value: string</span>) &#123;</span><br><span class=\"line\">  !arg</span><br><span class=\"line\">    ? el.<span class=\"title function_\">setAttribute</span>(<span class=\"string\">&quot;src&quot;</span>, value)</span><br><span class=\"line\">    : (el.<span class=\"property\">style</span>.<span class=\"property\">backgroundImage</span> = <span class=\"string\">`url(\\&quot;<span class=\"subst\">$&#123;value&#125;</span>\\&quot;)`</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * * <span class=\"doctag\">@Description</span>: 初始化图片懒加载</span></span><br><span class=\"line\"><span class=\"comment\"> * * <span class=\"doctag\">@Author</span>: shuhongxie</span></span><br><span class=\"line\"><span class=\"comment\"> * * <span class=\"doctag\">@param</span> &#123;<span class=\"type\">HTMLElement</span>&#125; el DOM元素</span></span><br><span class=\"line\"><span class=\"comment\"> * * <span class=\"doctag\">@param</span> &#123;<span class=\"type\">DirectiveBinding</span>&#125; <span class=\"variable\">binding</span></span></span><br><span class=\"line\"><span class=\"comment\"> **/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">initLazy</span>(<span class=\"params\">el: HTMLElement, binding: DirectiveBinding</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 默认图片</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> beforeHandImage =</span><br><span class=\"line\">    el.<span class=\"title function_\">getAttribute</span>(<span class=\"string\">&quot;lazy-init-img&quot;</span>) || <span class=\"string\">&quot;http://www.ay1.cc/img?w=300&amp;h=300&quot;</span>;</span><br><span class=\"line\">  <span class=\"comment\">// 屏幕高度   const contentHeight = document.body.clientHeight</span></span><br><span class=\"line\">  <span class=\"comment\">// 不使用offsetTop是因为如果父级有定位的话 那么offsetTop是相对于父级而不是浏览器窗口</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> elOffsetTop =</span><br><span class=\"line\">    el.<span class=\"title function_\">getBoundingClientRect</span>().<span class=\"property\">top</span> + <span class=\"variable language_\">document</span>.<span class=\"property\">documentElement</span>.<span class=\"property\">scrollTop</span>;</span><br><span class=\"line\">  <span class=\"comment\">// 图片高度大于当前屏幕就替换调原始图片</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (elOffsetTop &gt; contentHeight) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 没有就直接赋值当前图片</span></span><br><span class=\"line\">    <span class=\"title function_\">setStyle</span>(binding.<span class=\"property\">arg</span>, el, beforeHandImage);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_\">setStyle</span>(binding.<span class=\"property\">arg</span>, el, binding.<span class=\"property\">value</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"variable language_\">window</span>.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;scroll&quot;</span>, <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> scrollTop =</span><br><span class=\"line\">      <span class=\"variable language_\">document</span>.<span class=\"property\">documentElement</span>.<span class=\"property\">scrollTop</span> ||</span><br><span class=\"line\">      <span class=\"variable language_\">window</span>.<span class=\"property\">pageYOffset</span> ||</span><br><span class=\"line\">      <span class=\"variable language_\">document</span>.<span class=\"property\">body</span>.<span class=\"property\">scrollTop</span>; <span class=\"comment\">// 刷新完重新定义高度</span></span><br><span class=\"line\">    elOffsetTop =</span><br><span class=\"line\">      el.<span class=\"title function_\">getBoundingClientRect</span>().<span class=\"property\">top</span> + <span class=\"variable language_\">document</span>.<span class=\"property\">documentElement</span>.<span class=\"property\">scrollTop</span>; <span class=\"comment\">// 到达可视区就设置样式</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (scrollTop + contentHeight &gt; elOffsetTop) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">setStyle</span>(binding.<span class=\"property\">arg</span>, el, binding.<span class=\"property\">value</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> (<span class=\"attr\">app</span>: <span class=\"title class_\">App</span>) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"comment\">// v-lazy 图片懒加载指令 beforeHandImage 初始化的图片</span></span><br><span class=\"line\">  app.<span class=\"title function_\">directive</span>(<span class=\"string\">&quot;lazy&quot;</span>, &#123;</span><br><span class=\"line\">    <span class=\"title function_\">mounted</span>(<span class=\"params\">el, binding, vnode, oldVnode</span>) &#123;</span><br><span class=\"line\">      <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_\">initLazy</span>(el, binding);</span><br><span class=\"line\">      &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"title function_\">updated</span>(<span class=\"params\">el, binding</span>) &#123;</span><br><span class=\"line\">      <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_\">initLazy</span>(el, binding);</span><br><span class=\"line\">      &#125;, <span class=\"number\">0</span>);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"title function_\">unmounted</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">window</span>.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;scroll&quot;</span>, <span class=\"literal\">null</span>);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>可以看到，上图通过定义个一个 lazy-init-img 的自定义属性和传入了一个 background 指令参数来切换成背景图模式，不传则是图片模式，通过使用 getBoundingClientRect 方法获取到浏览器的距离，在所有队列任务执行完之后重新计算高度，执行对应的逻辑</p>\n","text":"之前用习惯了别人的图片懒加载指令，现在自己也试着写了一个，在这里记录下自己过程中的心得体会，当前指令逻辑使用于 vue2 和 vue3 图片懒加载原理使用 ht...","permalink":"/post/Vue3自定义图片懒加载指令","photos":[],"count_time":{"symbolsCount":"2.7k","symbolsTime":"2 mins."},"categories":[{"name":"vue3","slug":"vue3","count":1,"path":"api/categories/vue3.json"},{"name":"经验","slug":"vue3/经验","count":1,"path":"api/categories/vue3/经验.json"}],"tags":[{"name":"Vue3","slug":"Vue3","count":2,"path":"api/tags/Vue3.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%9B%BE%E7%89%87%E6%87%92%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86\"><span class=\"toc-text\">图片懒加载原理</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%BC%80%E5%A7%8B-%E9%9C%80%E8%A6%81%E6%98%8E%E7%99%BD%E7%9A%84%E4%B8%A4%E7%82%B9\"><span class=\"toc-text\">开始 需要明白的两点</span></a></li></ol>","author":{"name":"谢小谢","slug":"blog-author","avatar":"https://blog-1300014307.cos.ap-guangzhou.myqcloud.com/logo24.png","link":"/","description":"Love Music, love life","socials":{"github":"https://github.com/ShuHongXie","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"厨易科技低代码平台搭建思考","uid":"717767a9d0fa35b0ddd204ab9b9e0cde","slug":"厨易科技低代码平台搭建思考","date":"2023-06-30T16:00:00.000Z","updated":"2024-06-07T03:20:18.000Z","comments":true,"path":"api/articles/厨易科技低代码平台搭建思考.json","keywords":"蔡惠霖的博客，前端开发，Vue，Node.js","cover":"https://blog-1300014307.cos.ap-guangzhou.myqcloud.com/activity.png?imageMogr2/thumbnail/600","text":"由于公司之前的项目用的有赞的 saas，每年的费用高达几十万，对于小公司来说是一笔不小的支出所以另行组建了团队。我 5 月份进来作为前端这块的组长，在主导小程序...","permalink":"/post/厨易科技低代码平台搭建思考","photos":[],"count_time":{"symbolsCount":"1.1k","symbolsTime":"1 mins."},"categories":[{"name":"低代码","slug":"低代码","count":1,"path":"api/categories/低代码.json"}],"tags":[{"name":"原生小程序","slug":"原生小程序","count":2,"path":"api/tags/原生小程序.json"},{"name":"物料系统","slug":"物料系统","count":1,"path":"api/tags/物料系统.json"}],"author":{"name":"谢小谢","slug":"blog-author","avatar":"https://blog-1300014307.cos.ap-guangzhou.myqcloud.com/logo24.png","link":"/","description":"Love Music, love life","socials":{"github":"https://github.com/ShuHongXie","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"uni-app微信小程序实现axios请求拦截器和重复请求中断","uid":"0f52401eaa7baffae19fe63567938437","slug":"uni-app微信小程序实现axios请求拦截器和重复请求中断","date":"2022-12-07T16:00:00.000Z","updated":"2024-06-07T03:20:18.000Z","comments":true,"path":"api/articles/uni-app微信小程序实现axios请求拦截器和重复请求中断.json","keywords":"蔡惠霖的博客，前端开发，Vue，Node.js","cover":"http://www.xiesmallxie.cn/20211208153631.jpeg","text":"最近在写二手表微信小程序的时候，发现老是会有重复请求的情况，用了函数防抖和布尔拦截之后，又显得非常臃肿，没能从根本上解决问题，刚好 leader 叫我做一下重复...","permalink":"/post/uni-app微信小程序实现axios请求拦截器和重复请求中断","photos":[],"count_time":{"symbolsCount":"5.1k","symbolsTime":"5 mins."},"categories":[{"name":"axios","slug":"axios","count":1,"path":"api/categories/axios.json"},{"name":"微信小程序","slug":"axios/微信小程序","count":1,"path":"api/categories/axios/微信小程序.json"}],"tags":[{"name":"uni-app","slug":"uni-app","count":4,"path":"api/tags/uni-app.json"},{"name":"http","slug":"http","count":4,"path":"api/tags/http.json"},{"name":"微信小程序","slug":"微信小程序","count":2,"path":"api/tags/微信小程序.json"}],"author":{"name":"谢小谢","slug":"blog-author","avatar":"https://blog-1300014307.cos.ap-guangzhou.myqcloud.com/logo24.png","link":"/","description":"Love Music, love life","socials":{"github":"https://github.com/ShuHongXie","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}