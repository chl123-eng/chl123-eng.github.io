{"title":"记一次企业微信WX JS-SDK的不同设备下的问题","uid":"baf239d953fd03e4fb1a47a4e7060466","slug":"记一次企业微信WX JS-SDK的不同设备下的问题","date":"2020-09-13T16:00:00.000Z","updated":"2024-06-07T03:20:18.000Z","comments":true,"path":"api/articles/记一次企业微信WX JS-SDK的不同设备下的问题.json","keywords":"蔡惠霖的博客，前端开发，Vue，Node.js","cover":"https://blog-1300014307.cos.ap-guangzhou.myqcloud.com/js-sdk-01.png","content":"<p>问题记录: 最近在一次企业微信的 jssdk 的调用过程中发现 IOS 设备下在功能页初始化配置微信 js-sdk 无效。</p>\n<p>解决方法: Android 下获取微信 js-sdk 配置只需传 window.href。 IOS 下传 location.href.split( ‘# ‘)[0] ### 方法封装 #### 对微信 js-sdk 初始化进行配置</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> wx <span class=\"keyword\">from</span> <span class=\"string\">&quot;weixin-js-sdk &quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; getWxJssdk &#125; <span class=\"keyword\">from</span> <span class=\"string\">&quot;@/api/customer &quot;</span>;</span><br><span class=\"line\"><span class=\"comment\">/* \t* 判断是否IOS环境 \t* */</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">function</span> <span class=\"title function_\">isIOS</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> isIphone = navigator.<span class=\"property\">userAgent</span>.<span class=\"title function_\">includes</span>(<span class=\"string\">&quot;iPhone &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">let</span> isIpad = navigator.<span class=\"property\">userAgent</span>.<span class=\"title function_\">includes</span>(<span class=\"string\">&quot;iPad &quot;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> isIphone || isIpad;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/** 获取微信签名，注入权限验证配置 \t* */</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">requestWxStr</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> url = <span class=\"title function_\">isIOS</span>() ? location.<span class=\"property\">href</span>.<span class=\"title function_\">split</span>(<span class=\"string\">&quot;# &quot;</span>)[<span class=\"number\">0</span>] : location.<span class=\"property\">href</span>;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> params = &#123; <span class=\"string\">&quot;localUrl &quot;</span>: location.<span class=\"property\">href</span>.<span class=\"title function_\">split</span>(<span class=\"string\">&quot;# &quot;</span>)[<span class=\"number\">0</span>] &#125;;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> res = <span class=\"keyword\">await</span> <span class=\"title function_\">getWxJssdk</span>(&#123; url &#125;);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (res.<span class=\"property\">signature</span>) &#123;</span><br><span class=\"line\">      wx.<span class=\"title function_\">config</span>(&#123;</span><br><span class=\"line\">        <span class=\"attr\">beta</span>: <span class=\"literal\">true</span>, <span class=\"comment\">// 必须这么写，否则wx.invoke调用形式的jsapi会有问题</span></span><br><span class=\"line\">        <span class=\"attr\">debug</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">        <span class=\"attr\">appId</span>: res.<span class=\"property\">signature</span>.<span class=\"property\">appId</span>,</span><br><span class=\"line\">        <span class=\"attr\">timestamp</span>: res.<span class=\"property\">signature</span>.<span class=\"property\">timestamp</span>, <span class=\"comment\">// 必填，生成签名的时间戳</span></span><br><span class=\"line\">        <span class=\"attr\">nonceStr</span>: res.<span class=\"property\">signature</span>.<span class=\"property\">nonceStr</span>, <span class=\"comment\">// 必填，生成签名的随机串</span></span><br><span class=\"line\">        <span class=\"attr\">signature</span>: res.<span class=\"property\">signature</span>.<span class=\"property\">signature</span>, <span class=\"comment\">// 必填，签名，见 附录-JS-SDK使用权限签名算法</span></span><br><span class=\"line\">        <span class=\"attr\">jsApiList</span>: [<span class=\"string\">&quot;onMenuShareWechat &quot;</span>, <span class=\"string\">&quot;shareWechatMessage &quot;</span>],</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (e) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"路由初始化时判断设备类型进行配置\"><a href=\"#路由初始化时判断设备类型进行配置\" class=\"headerlink\" title=\"路由初始化时判断设备类型进行配置\"></a>路由初始化时判断设备类型进行配置</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router.<span class=\"title function_\">beforeEach</span>(<span class=\"function\">(<span class=\"params\">to, <span class=\"keyword\">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"title function_\">isIOS</span>()) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">from</span>.<span class=\"property\">path</span> === <span class=\"string\">&quot;/&quot;</span>) &#123;</span><br><span class=\"line\">      <span class=\"title function_\">requestWxStr</span>(); <span class=\"comment\">//该函数和之前一样，被单独提取出来了</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"功能页如果不是-IOS-页面就初始化\"><a href=\"#功能页如果不是-IOS-页面就初始化\" class=\"headerlink\" title=\"功能页如果不是 IOS 页面就初始化\"></a>功能页如果不是 IOS 页面就初始化</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">created</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!<span class=\"title function_\">isIOS</span>()) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">requestWxStr</span>();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n","text":"问题记录: 最近在一次企业微信的 jssdk 的调用过程中发现 IOS 设备下在功能页初始化配置微信 js-sdk 无效。 解决方法: Android 下获取微...","permalink":"/post/记一次企业微信WX JS-SDK的不同设备下的问题","photos":[],"count_time":{"symbolsCount":"1.7k","symbolsTime":"2 mins."},"categories":[{"name":"经验","slug":"经验","count":6,"path":"api/categories/经验.json"}],"tags":[{"name":"canvas","slug":"canvas","count":3,"path":"api/tags/canvas.json"},{"name":"js-sdk","slug":"js-sdk","count":1,"path":"api/tags/js-sdk.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%B7%AF%E7%94%B1%E5%88%9D%E5%A7%8B%E5%8C%96%E6%97%B6%E5%88%A4%E6%96%AD%E8%AE%BE%E5%A4%87%E7%B1%BB%E5%9E%8B%E8%BF%9B%E8%A1%8C%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">路由初始化时判断设备类型进行配置</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%8A%9F%E8%83%BD%E9%A1%B5%E5%A6%82%E6%9E%9C%E4%B8%8D%E6%98%AF-IOS-%E9%A1%B5%E9%9D%A2%E5%B0%B1%E5%88%9D%E5%A7%8B%E5%8C%96\"><span class=\"toc-text\">功能页如果不是 IOS 页面就初始化</span></a></li></ol>","author":{"name":"谢小谢","slug":"blog-author","avatar":"https://blog-1300014307.cos.ap-guangzhou.myqcloud.com/logo24.png","link":"/","description":"Love Music, love life","socials":{"github":"https://github.com/ShuHongXie","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"Vue动态组件打包实测","uid":"3579d33c3390fb8f737ed089f4ee848a","slug":"Vue动态组件打包实测","date":"2020-09-13T16:00:00.000Z","updated":"2024-06-07T03:20:18.000Z","comments":true,"path":"api/articles/Vue动态组件打包实测.json","keywords":"蔡惠霖的博客，前端开发，Vue，Node.js","cover":"https://blog-1300014307.cos.ap-guangzhou.myqcloud.com/webpack.png","text":"记录一次关于 Vue 动态组件打包的异同...","permalink":"/post/Vue动态组件打包实测","photos":[],"count_time":{"symbolsCount":"1.4k","symbolsTime":"1 mins."},"categories":[{"name":"webpack","slug":"webpack","count":2,"path":"api/categories/webpack.json"},{"name":"总结","slug":"webpack/总结","count":2,"path":"api/categories/webpack/总结.json"}],"tags":[{"name":"webpack","slug":"webpack","count":2,"path":"api/tags/webpack.json"}],"author":{"name":"谢小谢","slug":"blog-author","avatar":"https://blog-1300014307.cos.ap-guangzhou.myqcloud.com/logo24.png","link":"/","description":"Love Music, love life","socials":{"github":"https://github.com/ShuHongXie","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"HTTP缓存机制记录","uid":"977046a105528b08c6104c9e8e95e023","slug":"HTTP缓存机制记录","date":"2019-12-03T16:00:00.000Z","updated":"2024-06-07T03:20:18.000Z","comments":true,"path":"api/articles/HTTP缓存机制记录.json","keywords":"蔡惠霖的博客，前端开发，Vue，Node.js","cover":"https://blog-1300014307.cos.ap-guangzhou.myqcloud.com/http01.png","text":"http 缓存机制很容易就忘记了 这里大概记录一下 简单概括http 缓存分为强缓存(Cache-Control > Expires),协商缓存(Etag / ...","permalink":"/post/HTTP缓存机制记录","photos":[],"count_time":{"symbolsCount":"1.4k","symbolsTime":"1 mins."},"categories":[{"name":"http","slug":"http","count":2,"path":"api/categories/http.json"},{"name":"总结","slug":"http/总结","count":1,"path":"api/categories/http/总结.json"}],"tags":[{"name":"http","slug":"http","count":4,"path":"api/tags/http.json"}],"author":{"name":"谢小谢","slug":"blog-author","avatar":"https://blog-1300014307.cos.ap-guangzhou.myqcloud.com/logo24.png","link":"/","description":"Love Music, love life","socials":{"github":"https://github.com/ShuHongXie","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}